# Install dependencies only when needed
FROM node:16-bullseye-slim as builder
RUN apt-get update && apt-get install -y openssl pkg-config libpixman-1-dev libcairo2-dev libxt-dev libjpeg-dev libgif-dev libpango1.0-dev
RUN apt-get install -y python3 g++ make
# build-time arguments that NextJS needs when transpiling:
ARG NEXT_PUBLIC_SPAMPAGE_FIREBASE_API_KEY
ENV NEXT_PUBLIC_SPAMPAGE_FIREBASE_API_KEY ${NEXT_PUBLIC_SPAMPAGE_FIREBASE_API_KEY}
ARG NEXT_PUBLIC_SPAMPAGE_FIREBASE_AUTH_DOMAIN
ENV NEXT_PUBLIC_SPAMPAGE_FIREBASE_AUTH_DOMAIN ${NEXT_PUBLIC_SPAMPAGE_FIREBASE_AUTH_DOMAIN}
ARG NEXT_PUBLIC_SPAMPAGE_FIREBASE_PROJECT_ID
ENV NEXT_PUBLIC_SPAMPAGE_FIREBASE_PROJECT_ID ${NEXT_PUBLIC_SPAMPAGE_FIREBASE_PROJECT_ID}
ARG NEXT_PUBLIC_SPAMPAGE_FIREBASE_STORAGE_BUCKET
ENV NEXT_PUBLIC_SPAMPAGE_FIREBASE_STORAGE_BUCKET ${NEXT_PUBLIC_SPAMPAGE_FIREBASE_STORAGE_BUCKET}
ARG NEXT_PUBLIC_SPAMPAGE_FIREBASE_MESSAGING_SENDER_ID
ENV NEXT_PUBLIC_SPAMPAGE_FIREBASE_MESSAGING_SENDER_ID ${NEXT_PUBLIC_SPAMPAGE_FIREBASE_MESSAGING_SENDER_ID}
ARG NEXT_PUBLIC_SPAMPAGE_FIREBASE_APP_ID
ENV NEXT_PUBLIC_SPAMPAGE_FIREBASE_APP_ID ${NEXT_PUBLIC_SPAMPAGE_FIREBASE_APP_ID}
ARG NEXT_PUBLIC_SPAMPAGE_FIREBASE_MEASUREMENT_ID
ENV NEXT_PUBLIC_SPAMPAGE_FIREBASE_MEASUREMENT_ID ${NEXT_PUBLIC_SPAMPAGE_FIREBASE_MEASUREMENT_ID}
ARG MYSTATS_AUTHKEY
ENV MYSTATS_AUTHKEY ${MYSTATS_AUTHKEY}
ARG EMAIL_USERNAME
ENV EMAIL_USERNAME ${EMAIL_USERNAME}
ARG EMAIL_PASSWORD
ENV EMAIL_PASSWORD ${EMAIL_PASSWORD}
ENV NODE_ENV production
WORKDIR /app
RUN yarn global add turbo
RUN yarn set version stable
COPY . .
RUN turbo prune --scope=@yungsten/spamcntrl-langingpage --docker
RUN yarn set version stable
RUN yarn install
RUN yarn build --filter=@yungsten/spamcntrl-langingpage

EXPOSE 3000
ENV PORT 3000

# Run the NextJS start script
CMD ["yarn", "--cwd", "apps/spamcntrl-landingpage", "next", "start"]